CREATE TABLE public.cuentas_empleados_geo AS(
SELECT a.cuenta,
              a.status,
              a.created_t,
              a.vida_util,
              a.anio_created,
              a.mes_created,
              a.status_cuenta,
              a.motivo_cancelacion,
              a.cancel_time,anio_cancel,
              a.mes_cancel,
              a.oportunidad,
              a.id_empleado,
              a.empleado,
              a.tipo,
              a.ganada,
              a.zona,
              a.desc_servicio,
              a.cluster,
              a.distrito,
              a.ciudad,
              a.plaza,
              a.region, 
              a.tipo_bundle,
              a.familia, 
              a.fam_num,
              a.geolocalizacioninstalacion_la,
              a.geolocalizacioninstalacion_long,
              a.planservicio,
              a.leadsource,
              d.d_codigo,
              d.d_mnpio,
              d.d_estado 
FROM((SELECT  cuenta,
              status,
              created_t,
              vida_util,
              anio_created,
              mes_created,
              status_cuenta,
              motivo_cancelacion,
              cancel_time,anio_cancel,
              mes_cancel,
              oportunidad,
              id_empleado,
              empleado,
              tipo,
              ganada,
              zona,
              desc_servicio,
              cluster,
              distrito,
              ciudad,
              plaza,
              region, 
              tipo_bundle,
              familia, 
              fam_num,
              geolocalizacioninstalacion_la,
              geolocalizacioninstalacion_long,
              planservicio,
              leadsource
FROM public.cuentas_v_empleados_geo) AS a
left join (select idcuentabrm__c as cuenta ,
                              d_codigo,
                              d_mnpio,
                              d_estado 
                       from(SELECT cf.idcuentabrm__c,
                                   s.d_codigo,
                                   s.d_mnpio,
                                   s.d_estado
                            FROM nuevos_negocios.sepomex AS s 
                            JOIN data_staging.slf_cuentafactura__c AS cf
                            ON s.d_codigo=cf.codigopostalinstalacion__c
                            WHERE cf.info_day = 20230208)
                       group by cuenta ,
                                d_codigo,
                                d_mnpio,
                                d_estado) as d
             ON a.cuenta=d.cuenta)
);
COMMIT;
